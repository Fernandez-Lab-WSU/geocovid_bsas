{
  "hash": "ceb96ec99b94a2f0733048002fd5eb22",
  "result": {
    "markdown": "---\ntitle: \"Creación Mapas Buenos Aires\"\nlang: es\n---\n\n\n---\n\n**Input inicial**\n- Mapas vectoriales de provincia de Buenos Aires y AMBA\n\n**Objetivo**\n- Generar mapas de menor tamaño para que la aplicacion no tenga problemas de eficiencia.\n- Producir un mapa de Buenos Aires dónde no se diferencien las comunas de CABA.\n- Obtener los centroides de los departamentos de provincia de Buenos Aires\n\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(stringr)\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'sf' was built under R version 4.2.3\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE\n```\n:::\n\n```{.r .cell-code}\n# El amba consta de 40 municipios mas ciudad de buenos aires\n# fuente: https://www.argentina.gob.ar/dami/centro/amba\n# Vamos a hacer una seleccion de amba con menos partidos\n\n# Lista de los partidos que vamos a considerar AMBA incluyendo comunas CABA\namba_reducido_names <- c('Almirante Brown',\n                         'Avellaneda',\n                         'Berazategui',\n                         paste('Comuna', 1:15), # CABA\n                         'Esteban Echeverría', 'Escobar', 'Ezeiza',\n                         'Florencio Varela',\n                         'General San Martín',\n                         'Hurlingham',\n                         'Ituzaingó',\n                         'José C. Paz',\n                         'La Matanza',  'Lanús', 'Lomas de Zamora',\n                         'Malvinas Argentinas', 'Merlo', 'Moreno', 'Morón',\n                         'Quilmes', 'Pilar', 'Presidente Perón',\n                         'San Fernando', 'San Isidro', 'San Miguel',\n                         'Tigre', 'Tres de Febrero',\n                         'Vicente López')\n```\n:::\n\n\n# Area Metropolitana de Buenos Aires (AMBA) y Ciudad Autonoma de Buenos Aires (CABA)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Estos shapefiles fueron extraidos del Instituto Geografico Nacional (IGN)\n\namba <- st_read(\"data/inicial/departamentos.shp\") |>\n  st_zm() |>\n  filter(str_detect(NAM, paste(amba_reducido_names, collapse = \"|\")),\n         SAG %in% c('ARBA - Gerencia de Servicios Catastrales',\n                    'Direc. de Catastro'))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `departamentos' from data source \n  `/Users/florenciadandrea/geocovid_bsas/data/inicial/departamentos.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 529 features and 10 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY, XYZ\nBounding box:  xmin: -74 ymin: -90 xmax: -25 ymax: -21.78113\nz_range:       zmin: 0 zmax: 0\nGeodetic CRS:  WGS 84\n```\n:::\n\n```{.r .cell-code}\n# Chequeo el resultado visualmente\namba_reducido <- amba |>\n  dplyr::select('partido' = NAM , geometry) |>\n  dplyr::filter(partido %in% amba_reducido_names)\n\nggplot() +\n  geom_sf(data = amba_reducido)+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n### Remuevo poligonos duplicados\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Vemos que San Fernando esta compuesto por dos poligonos,\n# Uno es el delta, y deberiamos eliminarlo\n\nggplot() +\n  geom_sf(data = subset(amba_reducido,\n                        partido == 'San Fernando'))+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Lo paso a poligono para eliminar el extra\namba_reducido = st_cast(amba_reducido,\"POLYGON\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_cast.sf(amba_reducido, \"POLYGON\"): repeating attributes for all\nsub-geometries for which they may not be constant\n```\n:::\n\n```{.r .cell-code}\n# Chequeo que se cual quiero eliminar\nggplot() +\n  geom_sf(data = amba_reducido$geom[30])+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# Elimino el poligono extra\namba_reducido <- amba_reducido[-30,]\n\n# Archivo vectorial final de AMBA\nggplot() +\n  geom_sf(data = amba_reducido)+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n:::\n\n\n\nEste es el archivo con los poligonos finales seleccionados para AMBA\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## guardo el archivo\n\nst_write(amba_reducido, \"data/procesada/amba_reducido.gpkg\", append = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDeleting layer `amba_reducido' using driver `GPKG'\nWriting layer `amba_reducido' to data source \n  `data/procesada/amba_reducido.gpkg' using driver `GPKG'\nWriting 42 features with 1 fields and geometry type Polygon.\n```\n:::\n:::\n\n\n\n\n# Provincia de Buenos Aires\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtengo los poligonos desde el IGN\nbsas <- sf::st_read('data/inicial/departamentos.shp') |>\n  dplyr::filter(SAG %in% c('Direc. de Catastro', # comunas\n                           'ARBA - Gerencia de Servicios Catastrales'), # partidos de baires\n                GNA %in% c('Partido', 'Comuna')) |> # elimino prov de san juan\n  dplyr::select('partido' = NAM, geometry) |>\n  sf::st_zm()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `departamentos' from data source \n  `/Users/florenciadandrea/geocovid_bsas/data/inicial/departamentos.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 529 features and 10 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY, XYZ\nBounding box:  xmin: -74 ymin: -90 xmax: -25 ymax: -21.78113\nz_range:       zmin: 0 zmax: 0\nGeodetic CRS:  WGS 84\n```\n:::\n\n```{.r .cell-code}\n# Lo paso a poligono para eliminar el extra en San Fernando\nbsas = st_cast(bsas,\"POLYGON\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_cast.sf(bsas, \"POLYGON\"): repeating attributes for all\nsub-geometries for which they may not be constant\n```\n:::\n\n```{.r .cell-code}\n# Chequeo el numero de poligono que quiero eliminar\nggplot() +\n  geom_sf(data = bsas$geometry[126])+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Elimino el poligono extra\nbsas <- bsas[-126,]\n\n# Mapa final\nggplot() +\n  geom_sf(data = bsas)+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# Llamo al archivo bsas_comunas ya que presenta las comunas de CABA\nwrite_sf(bsas, 'data/procesada/bsas_comunas.gpkg')\n```\n:::\n\n\n### Unifico las comunas\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  # uno las comunas\n  caba <-  bsas[grep(\"Comuna\", bsas$partido), ] |>\n           st_union()\n\n  # aca podria agregar algun tipo de control de calidad para asegurarme que\n  # tengo la cantidad de comunas que son\n  # chequear que tenga proyeccion\n\n\n  # las reemplazo en el dataset por caba\n bsas_caba <-  bsas |>\n    slice(-grep(\"Comuna\", bsas$partido)) |>\n    rbind(st_sf(\n                geometry = caba,\n                partido = 'Capital Federal'\n    ))\n\n\n\n ggplot() +\n        geom_sf(data = subset(bsas_caba,\n                              partido == 'Capital Federal')) + \n        theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Llamo a este archivo bsas ya que no presenta la division interna de CABA\n# en comunas\n \nwrite_sf(bsas_caba, 'data/procesada/bsas.gpkg')\n```\n:::\n\n\n### Simplifico los poligonos para agilizar la app\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbsas_caba <- st_read('data/procesada/bsas.gpkg')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `bsas' from data source \n  `/Users/florenciadandrea/geocovid_bsas/data/procesada/bsas.gpkg' \n  using driver `GPKG'\nSimple feature collection with 136 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -63.38597 ymin: -41.03791 xmax: -56.66499 ymax: -33.26185\nGeodetic CRS:  WGS 84\n```\n:::\n\n```{.r .cell-code}\n# Es posible emplear la funcion st_simplify para esto mismo, pero no conserva\n# tan bien la topografia entre los poligonos, es por ello que uso este paquete\n# donde se aplica el algoritmo de Visvalingam\n\nlibrary(rmapshaper)\nbsas_caba_simple <- rmapshaper::ms_simplify(bsas_caba)\n```\n:::\n\n\n### Incluyo coordenadas de la bounding box \n\nRealizo este paso para que sea más sencillo hacer el zoom en el mapa.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Agrego coordenadas al mapa de BsAs que voy a necesitar\n# para hacer zoom en la app\n\n\nfor(i in seq_along(1:nrow(bsas_caba_simple))){\n  \n  bsas_caba_simple[i, \"lat1\"] <- sf::st_bbox(bsas_caba_simple[i,])$ymin\n  bsas_caba_simple[i,\"lat2\"] <- sf::st_bbox(bsas_caba_simple[i,])$ymax\n  bsas_caba_simple[i, \"lng1\"] <- sf::st_bbox(bsas_caba_simple[i,])$xmin\n  bsas_caba_simple[i, \"lng2\"] <- sf::st_bbox(bsas_caba_simple[i,])$xmax\n  \n}\n\nst_write(bsas_caba_simple, \"data/procesada/bsas_final.gpkg\", append=FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDeleting layer `bsas_final' using driver `GPKG'\nWriting layer `bsas_final' to data source \n  `data/procesada/bsas_final.gpkg' using driver `GPKG'\nWriting 136 features with 5 fields and geometry type Polygon.\n```\n:::\n:::\n\n\n\n### Calculo de centroides\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncent <- bsas_caba_simple |> \n  st_point_on_surface()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: st_point_on_surface assumes attributes are constant over geometries\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sfc(st_geometry(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n```\n:::\n\n```{.r .cell-code}\n# guardo el archivo con los vectores de partidos de provincia de Buenos Aires\n\nggplot() +\n  geom_sf(data = bsas_caba)+\n  geom_sf(data = cent) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](creacion_mapa_bsas_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Cambio nombres de partidos para evitar problemas al momento de hacer joins\ncent[78,'partido'] <- 'Lomas De Zamora'\ncent[132,'partido'] <- 'Tres De Febrero'\n\n\ncent <- cent |>\n         # salgo del formato sf: calculo lat y long como variables separadas\n          cbind(sf::st_coordinates(cent)) |>\n          dplyr::arrange(partido) |> \n          select(-lat1, -lat2, -lng1, -lng2)\n\n# elimino el formato sf\nsf::st_geometry(cent) <-  NULL\n\ncent\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                               partido         X         Y\n1                           25 de Mayo -60.28153 -35.55392\n2                           9 de Julio -60.92597 -35.53430\n3                        Adolfo Alsina -62.95972 -37.16983\n4               Adolfo Gonzales Chaves -60.28791 -37.94044\n5                              Alberti -60.28311 -35.02820\n6                      Almirante Brown -58.37581 -34.83383\n7                            Arrecifes -60.01660 -34.00289\n8                           Avellaneda -58.33643 -34.67923\n9                             Ayacucho -58.59323 -36.97672\n10                                Azul -59.68005 -36.83704\n11                        Bahía Blanca -62.18668 -38.59020\n12                            Balcarce -58.18939 -37.75310\n13                            Baradero -59.44140 -33.90786\n14                       Benito Juárez -59.88628 -37.58798\n15                         Berazategui -58.14120 -34.84363\n16                             Berisso -57.85202 -34.89866\n17                             Bolívar -61.15579 -36.29357\n18                             Bragado -60.60463 -35.02820\n19                            Brandsen -58.23788 -35.19553\n20                             Campana -58.88924 -34.15991\n21                     Capital Federal -58.43547 -34.61515\n22                   Capitán Sarmiento -59.84528 -34.14161\n23                      Carlos Casares -61.29527 -35.73349\n24                      Carlos Tejedor -62.43390 -35.39224\n25                     Carmen de Areco -59.92388 -34.42105\n26                            Castelli -57.65124 -36.01938\n27                            Cañuelas -58.72227 -35.15660\n28                           Chacabuco -60.32958 -34.63540\n29                           Chascomús -57.87466 -35.59756\n30                           Chivilcoy -59.97838 -34.90887\n31                               Colón -61.04032 -33.85050\n32                     Coronel Dorrego -61.15382 -38.64395\n33                    Coronel Pringles -61.24195 -38.16803\n34                      Coronel Suárez -61.91250 -37.54200\n35  Coronel de Marina Leonardo Rosales -61.93088 -38.81603\n36                            Daireaux -61.94126 -36.61709\n37                             Dolores -57.59941 -36.42196\n38                            Ensenada -57.97776 -34.84021\n39                             Escobar -58.77772 -34.34234\n40                  Esteban Echeverría -58.47645 -34.82407\n41               Exaltación de la Cruz -59.13155 -34.31044\n42                              Ezeiza -58.57336 -34.87375\n43                    Florencio Varela -58.25360 -34.88657\n44                 Florentino Ameghino -62.41611 -34.88750\n45                    General Alvarado -58.06044 -38.20038\n46                      General Alvear -60.10413 -36.04127\n47                    General Arenales -61.29278 -34.23922\n48                    General Belgrano -58.61672 -35.84266\n49                       General Guido -57.94733 -36.67494\n50              General Juan Madariaga -57.28162 -37.16193\n51                   General La Madrid -61.28003 -37.40732\n52                   General Las Heras -58.99601 -34.90984\n53                     General Lavalle -57.01046 -36.67784\n54                         General Paz -58.33569 -35.47546\n55                       General Pinto -61.97697 -34.68665\n56                  General Pueyrredón -57.78250 -37.97401\n57                   General Rodríguez -58.99482 -34.64047\n58                    General Viamonte -61.06068 -34.98104\n59                    General Villegas -62.99874 -34.87244\n60                             Guaminí -62.43702 -36.90480\n61                   Hipólito Yrigoyen -61.69276 -36.27273\n62                          Hurlingham -58.65275 -34.59981\n63                           Ituzaingó -58.68822 -34.64233\n64                         José C. Paz -58.78106 -34.50335\n65                               Junín -60.96998 -34.54486\n66                            La Costa -56.69242 -36.66074\n67                          La Matanza -58.63546 -34.77297\n68                            La Plata -57.99139 -35.03789\n69                               Lanús -58.39866 -34.70293\n70                             Laprida -60.64166 -37.49570\n71                          Las Flores -59.12327 -36.01897\n72                     Leandro N. Alem -61.64284 -34.49384\n73                              Lezama -57.93164 -35.86462\n74                             Lincoln -61.80579 -35.09365\n75                             Lobería -58.68880 -38.07036\n76                               Lobos -59.15286 -35.20128\n77                     Lomas De Zamora -58.57596 -34.54360\n78                     Lomas de Zamora -58.41026 -34.74998\n79                               Luján -59.15158 -34.58838\n80                           Magdalena -57.62397 -35.18716\n81                               Maipú -57.58922 -36.89209\n82                 Malvinas Argentinas -58.72082 -34.48464\n83                        Mar Chiquita -57.60642 -37.51881\n84                          Marcos Paz -58.83455 -34.82132\n85                            Mercedes -59.42672 -34.70347\n86                               Merlo -58.74705 -34.70788\n87                               Monte -58.75188 -35.49808\n88                       Monte Hermoso -61.28918 -38.95552\n89                              Moreno -58.80228 -34.59624\n90                               Morón -58.61937 -34.64628\n91                             Navarro -59.39377 -35.02273\n92                            Necochea -59.11314 -38.17667\n93                           Olavarría -60.71476 -36.85806\n94                           Patagones -62.86131 -40.18127\n95                             Pehuajó -61.97322 -35.90659\n96                          Pellegrini -63.16732 -36.24039\n97                                Pila -58.38114 -36.23235\n98                               Pilar -58.89737 -34.44171\n99                             Pinamar -56.86715 -37.10634\n100                   Presidente Perón -58.41364 -34.94209\n101                        Punta Indio -57.34538 -35.45684\n102                               Puán -63.03783 -38.11116\n103                            Quilmes -58.27554 -34.74127\n104                            Ramallo -60.03576 -33.58824\n105                              Rauch -58.91645 -36.60297\n106                          Rivadavia -63.02164 -35.57785\n107                              Rojas -60.72242 -34.19580\n108                        Roque Pérez -59.21778 -35.52084\n109                           Saavedra -62.43006 -37.74616\n110                          Saladillo -59.64920 -35.68244\n111                         Salliqueló -63.04286 -36.67565\n112                              Salto -60.30479 -34.24776\n113                San Andrés de Giles -59.47306 -34.42320\n114               San Antonio de Areco -59.56440 -34.20744\n115                       San Cayetano -59.63009 -38.40343\n116                       San Fernando -58.56731 -34.45870\n117                         San Isidro -58.53767 -34.48685\n118                         San Miguel -58.70184 -34.55303\n119                        San Nicolás -60.28747 -33.47246\n120                          San Pedro -59.82146 -33.79661\n121                        San Vicente -58.42015 -35.08145\n122                           Suipacha -59.71374 -34.73507\n123                             Tandil -59.18070 -37.33613\n124                           Tapalqué -60.22351 -36.36921\n125                              Tigre -58.61231 -34.40115\n126                           Tordillo -57.22011 -36.41438\n127                          Tornquist -62.18618 -38.26284\n128                    Trenque Lauquen -62.69757 -36.04662\n129                       Tres Arroyos -60.26733 -38.47286\n130                    Tres De Febrero -60.58050 -33.86411\n131                         Tres Lomas -62.88158 -36.48679\n132                    Tres de Febrero -58.56250 -34.60183\n133                      Vicente López -58.50640 -34.52899\n134                       Villa Gesell -57.06391 -37.36494\n135                          Villarino -62.86191 -39.15349\n136                             Zárate -59.14666 -34.00438\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# guardo los centroides\nwrite.csv(cent, \"data/procesada/centroides_mapa.csv\")\n```\n:::\n",
    "supporting": [
      "creacion_mapa_bsas_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}